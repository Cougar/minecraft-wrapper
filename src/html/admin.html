<!-- I'm sorry for how sloppy this code is. I truly am. -->
<!-- document.title = "Piops"("server_name").innerHTML = stats["server_name"] -->
<html>
	<head>
		<title>Wrapper.py Admin Page</title>
		<script type="text/javascript" src="requests.js"></script>
		<script type="text/javascript" >
			hasScrolled = false
			skins = {}
			invalidLogins = 0
			lastRefresh = 0
			_ = function(id) {return document.getElementById(id)}
			function isAuthed(){
				if(!localStorage.sessionKey) return false
				if(requests.action("is_admin", {"key": localStorage.sessionKey})["status"] == "good") return true
				return false
			}
			function loginWithPassword(password){
				r = requests.action("login", {"password": password})
				if (r["payload"] == "permission_denied"){
					_("login_invalid").style.display = "block"
					invalidLogins += 1
					if(invalidLogins > 1){
						_("login_invalid").innerHTML = "The password was invalid. (" + invalidLogins + ")"
					}
				}
				else{
					localStorage.sessionKey = r["payload"]["session-key"]
					console.log("Login Success!")
					window.location = ""
				}
			}
			window.onload = function() {
				if(isAuthed()){
					_("login_page").style.display = 'none'
					_("admin_page").style.display = 'block'
					tick()
				}
			}
			function handleScroll(z){
				hasScrolled = true
				if(z.scrollTop == z.scrollHeight) {hasScrolled = false;console.log('no scroll')}
			}
			function tick(){
				setTimeout("tick()", 2000)
				stats = requests.admin("admin_stats", {"last_refresh": lastRefresh})
				if(stats["status"] == "error"){
					console.log("Error while refreshing stats. Connection lost?")
					return
				}
				lastRefresh = stats["refresh_time"]
				statusMessages = {0: "<r>Server stopped</r>", 1: "<y>Server starting...</y>", 2: "<g>Running</g>", 3: "<y>Server stopping...</y>"}
				if(stats["server_state"] in statusMessages) _("server_status").innerHTML = statusMessages[stats["server_state"]]
				_("playercount_status").innerHTML = stats["playerCount"] + " players"
				_("levelname_status").innerHTML = stats["level_name"]
				_("server_version").innerHTML = stats["server_version"]
				_("server_motd").innerHTML = stats["motd"]
				_("server_name").innerHTML = stats["server_name"]
				document.title = stats["server_name"] + " - Wrapper.py Admin"
				
				// draw player list
				_("playerlist").innerHTML = "<th>?</th><th>Username</th><th>UUID</th><th>Options</th></tr>"
				for(i in stats["players"]){
					var player = stats["players"][i]
					if(!(player.uuid in skins)){
						skins[player.uuid] = requests.admin("get_player_skin", {"uuid": player.uuid})
					}
					
					if(player.isOp) var isOp = " class='op'"
					else isOp = ""					
					_("playerlist").innerHTML += "<td><canvas id='playerskin-"+player.name+"' width=16 height=16></canvas></td><td"+isOp+">"+player.name+"</td><td>"+player.uuid+"</td><td><button onclick='_kick("+i+")'>Kick</button> <button onclick='_ban("+i+")'>Ban</button> <button onclick='_op("+i+")'>OP</button> <button onclick='_deop("+i+")'>De-OP</button></td></tr>"
					if(skins[player.uuid] == null) return
					// the worst code ever. written in about five minutes.
					try{
						var pic = new Image()
						pic.src = "data:image/png;base64," + skins[player.uuid]
						var ctx = _("playerskin-" + player.name).getContext("2d")
						ctx.webkitImageSmoothingEnabled = false
						ctx.drawImage(pic, 8, 8, 8, 8, 0, 0, 16, 16)
					}catch(err){}
				}
				players = stats["players"]
				
				// draw plugin list
				_("pluginlist").innerHTML = "<th>Name</th><th>Description</th><th>Options</th></tr>"
				for(i in stats["plugins"]){
					var plugin = stats["plugins"][i]
					if(plugin.description) var description = plugin.description.replace("\n", "</br></br>")
					else var description = "<i>No description is available for this plugin.</i>"
					_("pluginlist").innerHTML += "<td style='white-space:nowrap;'>"+plugin.name+"</td><td>"+description+"</td><td style='white-space:nowrap;'><button onclick='_toggle_plugin(\""+plugin.id+"\", this)'>Disable</button></td></tr>"
				}
								
				// draw console
				var doScroll = false
				var p = _("server_console") 
				if(p.scrollTop + p.clientHeight == p.scrollHeight){
					var doScroll = true
				}
				if(stats["console"].length > 0)
					p.innerHTML += "\n" + stats["console"].join("\n")
				if(doScroll) p.scrollTop = p.scrollHeight
				
				// set wrapper.py build string
				_("buildstring").innerHTML = "Wrapper.py " + stats["wrapper_build"]
			}

			// admining functions
			function _start(){
				requests.admin("server_action", {"action": "start"})
			}
			function _stop(){
				message = prompt("Please enter a stop reason (will be shown to all players currently active on the server:", "Server stopping...")
				if(!message) return
				requests.admin("server_action", {"action": "stop", "reason": message})
			}
			function _restart(){
				message = prompt("Please enter a restart reason (will be shown to all players currently active on the server:", "Server restarting...")
				if(!message) return
				requests.admin("server_action", {"action": "restart", "reason": message})
			}
			function _kill(){
				if(confirm("Are you sure you want to forcefully kill the server process? This can corrupt the world file, and should only be used if the server is completely unresponsive.")){
					requests.admin("server_action", {"action": "kill"})
				}
			}
			function _kick(i){
				var player = players[i]
				message = prompt("Please enter a kick message for "+player.name+":")
				if(message){
					requests.admin("kick_player", {"player": player.name, "reason": message})
				}else{
					alert("Won't kick "+player.name+".")
				}
			}
			function _ban(i){
				var player = players[i]
				message = prompt("Please enter a ban message for "+player.name+":")
				if(message){
					requests.admin("ban_player", {"player": player.name, "reason": message})
				}else{
					alert("Won't ban "+player.name+".")
				}
			}
			function _op(i){
				var player = players[i]
				if(confirm("Are you sure you want to give operator to "+player.name+"?")){
					_console("op "+player.name)
				}
			}
			function _deop(i){
				var player = players[i]
				if(confirm("Are you sure you want to remove operator from "+player.name+"?")){
					_console("deop "+player.name)
				}
			}
			function _console(line){
				requests.admin("console", {"execute":line})
			}
			function _reload_plugins(){
				if(!confirm("Are you sure you want to reload all plugins?")) return
				requests.admin("reload_plugins", {})
				alert("Reloaded plugins.")
			}
			function _toggle_plugin(id, el){
				alert("Enabling and disabling plugins is not supported yet!")
				return
				// Doesn't actually do anything yet
				if(!confirm("Are you sure you want to disable the plugin '"+id+"'? Disabling a plugin will force a plugin reload.")) return
				if(el.innerHTML == "Disable"){
					el.innerHTML = "Enable"
				}else if(el.innerHTML == "Enable"){
					el.innerHTML = "Disable"
				}
			}
			function _login(){
				loginWithPassword(_('login_password').value)
			}
			function _logout(){
				requests.admin("logout", {})
				window.location = ""
			}
		</script>
		<style type="text/css">
			r{color:red;}
			y{color:gold;}
			g{color:green;}
			.small{
				font-style: italic;
				font-size: 12px;
			}
			.op{color:darkgoldenrod;}
		</style>
	</head>
	<body>
		<div id="login_page">
			<h1>Wrapper.py Admin Login</h1>
			<div id="login_invalid" style="display:none;color:red;font-weight:bold;">The password was invalid.</div>
			Password: <input type="password" id="login_password" onkeydown="if(event.keyCode==13){_login();this.value='';}"/><button onclick="_login()">Login</button>
		</div>
		<div id="admin_page" style="display:none;">
			<h1 id="server_name">Minecraft Server</h1>
			<button onclick="_logout()">Logout</button></br></br>
			This information refreshes every three seconds.</br>
			<b>Server Status: </b> <span id="server_status">Unknown</span></br>
			<b>Server Version: </b> <span id="server_version">Unknown</span></br>
			<b>Server MOTD: </b> <span id="server_motd">Unknown</span></br>
			<b>Level Name: </b> <span id="levelname_status">Unknown</span></br>
			<b>Player Count: </b> <span id="playercount_status">n/a players</span></br>
			<br/>
			<table border="1">
				<tbody id="playerlist">
					<th>Username</th><th>UUID</th><th>Options</th></tr>
				</tbody>
			</table>
			Gold names are operators. Skins only show up when proxy mode is enabled.
			</br></br>Server: <button onclick="_start()">Start</button> <button onclick="_restart()">Restart</button> <button onclick="_stop()">Stop</button> <button onclick="_kill()">Force Kill</button>
			</br></br><b>Server Console</b></br>
			<textarea disabled="" cols="80" rows="20" id="server_console" onscroll="handleScroll(this)"></textarea>
			<br/><input type="text" onkeydown="if(event.keyCode == 13){_console(this.value);this.value='';}" placeholder="Run a command in the Minecraft server console..." size="80"/>
			</br></br><b>Plugins</b></br>
			<button onclick="_reload_plugins()">Reload Plugins</button>
			<table border="1">
				<tbody id="pluginlist">
					<th>Name</th><th>Description</th><th>Options</th></tr>
				</tbody>
			</table>
		</div>
		<div class="small">Copyright Ben Baptist 2014</div>
		<div class="small" id="buildstring"></div>
	</body>
</html>